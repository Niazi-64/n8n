name: Deploy â†’ Gigalixir (n8n)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      GIGALIXIR_REMOTE_HOST: git.gigalixir.com

    steps:
      - name: Checkout repo (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create temporary deploy branch
        run: |
          git switch -c ci-deploy || git checkout -b ci-deploy

      - name: Ensure .buildpacks (Heroku Node.js)
        run: |
          echo "https://github.com/heroku/heroku-buildpack-nodejs.git" > .buildpacks
          git add .buildpacks
          git commit -m "ci: add Node.js buildpack for n8n [skip ci]" || echo "no changes to commit"

      - name: Add Gigalixir remote
        env:
          GIGALIXIR_EMAIL: ${{ secrets.GIGALIXIR_EMAIL }}
          GIGALIXIR_API_KEY: ${{ secrets.GIGALIXIR_API_KEY }}
          GIGALIXIR_APP_NAME: ${{ secrets.GIGALIXIR_APP_NAME }}
        run: |
          if [ -z "$GIGALIXIR_EMAIL" ] || [ -z "$GIGALIXIR_API_KEY" ] || [ -z "$GIGALIXIR_APP_NAME" ]; then
            echo "Missing required secrets: GIGALIXIR_EMAIL, GIGALIXIR_API_KEY, GIGALIXIR_APP_NAME"
            exit 1
          fi
          ENCODED_EMAIL=$(echo "$GIGALIXIR_EMAIL" | sed 's/@/%40/g')
          REMOTE_URL="https://${ENCODED_EMAIL}:${GIGALIXIR_API_KEY}@${GIGALIXIR_REMOTE_HOST}/${GIGALIXIR_APP_NAME}.git"
          git remote add gigalixir "$REMOTE_URL" 2>/dev/null || git remote set-url gigalixir "$REMOTE_URL"

      - name: Push to Gigalixir (trigger deploy)
        run: |
          echo "Pushing current HEAD to gigalixir:main to trigger deploy..."
          git push gigalixir HEAD:main --force
